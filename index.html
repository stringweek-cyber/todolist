<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘의 계획</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM & Lucide Icons -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.292.0"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Calendar as CalendarIcon, Plus, Trash2, Repeat, Menu, X, Edit2, CheckSquare, ChevronLeft, ChevronRight, Home } from 'lucide-react';

        const TodaysPlan = () => {
            // --- State ---
            const [currentDate, setCurrentDate] = useState(new Date());
            const [viewMode, setViewMode] = useState('weekly'); // 'weekly' or 'monthly'
            const [calendarViewDate, setCalendarViewDate] = useState(new Date()); 

            const [tasks, setTasks] = useState([]); 
            const [schedules, setSchedules] = useState({}); 
            const [recurring, setRecurring] = useState([]); 
            
            const [isMenuOpen, setIsMenuOpen] = useState(false); 
            const [isAddScheduleOpen, setIsAddScheduleOpen] = useState(false);
            
            // Add/Edit Form State
            const [selectedTime, setSelectedTime] = useState("09:00");
            const [selectedTaskText, setSelectedTaskText] = useState("");
            const [editingItem, setEditingItem] = useState(null); 

            // Recurring Form State
            const [recurStartAmPm, setRecurStartAmPm] = useState("PM");
            const [recurStartH, setRecurStartH] = useState("");
            const [recurStartM, setRecurStartM] = useState("");
            
            const [recurEndAmPm, setRecurEndAmPm] = useState("PM");
            const [recurEndH, setRecurEndH] = useState("");
            const [recurEndM, setRecurEndM] = useState("");

            const [recurText, setRecurText] = useState("");
            const [recurDays, setRecurDays] = useState([]); 
            const [editingRecurGroupId, setEditingRecurGroupId] = useState(null); 

            // --- Init & Persistence ---
            useEffect(() => {
                const savedTasks = JSON.parse(localStorage.getItem('my_tasks') || '[]');
                const savedSchedules = JSON.parse(localStorage.getItem('my_schedules') || '{}');
                const savedRecurring = JSON.parse(localStorage.getItem('my_recurring') || '[]');
                
                setTasks(savedTasks);
                setSchedules(savedSchedules);
                setRecurring(savedRecurring);
            }, []);

            useEffect(() => {
                localStorage.setItem('my_tasks', JSON.stringify(tasks));
                localStorage.setItem('my_schedules', JSON.stringify(schedules));
                localStorage.setItem('my_recurring', JSON.stringify(recurring));
            }, [tasks, schedules, recurring]);

            // --- Helpers ---
            
            const formatDateKey = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const formatAmPm = (hour) => {
                const h = parseInt(hour, 10);
                const ampm = h < 12 ? 'AM' : 'PM';
                const h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h === 12 ? 12 : h);
                return { ampm, h12 };
            };

            const to24Hour = (ampm, h, m) => {
                let hour = parseInt(h || 0, 10);
                if (ampm === 'PM' && hour < 12) hour += 12;
                if (ampm === 'AM' && hour === 12) hour = 0;
                return `${hour < 10 ? '0'+hour : hour}:${m || '00'}`;
            };

            const to12HourParts = (timeStr) => {
                const [hStr, mStr] = timeStr.split(':');
                const h = parseInt(hStr, 10);
                const ampm = h >= 12 ? 'PM' : 'AM';
                let h12 = h % 12;
                if (h12 === 0) h12 = 12;
                return { ampm, h: h12.toString(), m: mStr };
            };

            const generateTimeSlots = () => {
                const slots = [];
                for (let i = 9; i <= 23; i++) {
                const value = `${i < 10 ? '0' + i : i}:00`;
                const start = formatAmPm(i);
                const nextHRaw = i + 1;
                const next = formatAmPm(nextHRaw > 23 ? 0 : nextHRaw); 
                const label = `${start.ampm} ${start.h12}시 - ${next.h12}시`;
                slots.push({ value, label });
                }
                return slots;
            };
            
            const getDisplayTime = (item) => {
                if (!item.time) return "";
                if (item.endTime) {
                    const [sh, sm] = item.time.split(':').map(Number);
                    const [eh, em] = item.endTime.split(':').map(Number);
                    const start = formatAmPm(sh);
                    const end = formatAmPm(eh);
                    const startStr = `${start.ampm} ${start.h12}:${sm < 10 ? '0'+sm : sm}`;
                    const sLabel = sm === 0 ? `${start.ampm} ${start.h12}시` : startStr;
                    const eLabel = em === 0 ? `${end.h12}시` : `${end.h12}:${em < 10 ? '0'+em : em}`;
                    if (start.ampm !== end.ampm) return `${sLabel} - ${end.ampm} ${eLabel}`;
                    return `${sLabel} - ${eLabel}`;
                }
                const [h] = item.time.split(':').map(Number);
                const start = formatAmPm(h);
                const next = formatAmPm(h + 1 > 23 ? 0 : h + 1);
                return `${start.ampm} ${start.h12}시 - ${next.h12}시`;
            };

            const getWeekDays = (date) => {
                const start = new Date(date);
                start.setDate(start.getDate() - start.getDay());
                const days = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    days.push(d);
                }
                return days;
            };

            const getMonthDays = (viewDate) => {
                const year = viewDate.getFullYear();
                const month = viewDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay(); 
                
                const days = [];
                for (let i = 0; i < startDayOfWeek; i++) days.push(null);
                for (let i = 1; i <= daysInMonth; i++) days.push(new Date(year, month, i));
                return days;
            };

            const changeMonth = (offset) => {
                const newDate = new Date(calendarViewDate);
                newDate.setMonth(newDate.getMonth() + offset);
                setCalendarViewDate(newDate);
            };

            const getDayOfWeek = (date) => date.getDay(); 
            const getDayName = (dayIndex) => ['일','월','화','수','목','금','토'][dayIndex];
            const getDayColor = (dayIndex) => dayIndex === 0 ? 'text-red-500' : dayIndex === 6 ? 'text-blue-500' : 'text-gray-500';

            const getGroupedRecurring = () => {
                const groups = {};
                recurring.forEach(item => {
                    const key = `${item.time}-${item.endTime}-${item.text}`;
                    if (!groups[key]) groups[key] = { ...item, days: [], ids: [] };
                    if (!groups[key].days.includes(item.dayOfWeek)) groups[key].days.push(item.dayOfWeek);
                    groups[key].ids.push(item.id);
                });
                return Object.values(groups).sort((a,b) => a.time.localeCompare(b.time));
            };

            const getDayString = (days) => {
                const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
                return days.sort((a,b) => a - b).map(d => dayNames[d]).join(', ');
            };

            // --- CRUD Actions ---
            const addTaskToPool = (text) => {
                if (!text.trim()) return;
                if (!tasks.includes(text)) setTasks([...tasks, text]);
            };
            const removeTaskFromPool = (task) => setTasks(tasks.filter(t => t !== task));
            const toggleRecurDay = (dayIndex) => {
                if (recurDays.includes(dayIndex)) setRecurDays(recurDays.filter(d => d !== dayIndex));
                else setRecurDays([...recurDays, dayIndex].sort());
            };
            const toggleAmPm = (setter, current) => setter(current === 'AM' ? 'PM' : 'AM');

            const startEditRecurGroup = (groupItem) => {
                setEditingRecurGroupId(groupItem.id); 
                const startParts = to12HourParts(groupItem.time);
                setRecurStartAmPm(startParts.ampm); setRecurStartH(startParts.h); setRecurStartM(startParts.m);
                if (groupItem.endTime) {
                    const endParts = to12HourParts(groupItem.endTime);
                    setRecurEndAmPm(endParts.ampm); setRecurEndH(endParts.h); setRecurEndM(endParts.m);
                } else {
                    setRecurEndAmPm(startParts.ampm); setRecurEndH((parseInt(startParts.h)+1).toString()); setRecurEndM("00");
                }
                setRecurText(groupItem.text);
                setRecurDays([...groupItem.days]); 
            };

            const cancelEditRecur = () => {
                setEditingRecurGroupId(null); setRecurText(""); setRecurDays([]);
                setRecurStartAmPm("PM"); setRecurStartH(""); setRecurStartM("");
                setRecurEndAmPm("PM"); setRecurEndH(""); setRecurEndM("");
            };

            const saveRecurringSchedule = () => {
                if (!recurText || recurDays.length === 0 || !recurStartH || !recurEndH) {
                    alert("시간, 내용, 요일을 모두 입력해주세요.");
                    return;
                }
                const timeStr = to24Hour(recurStartAmPm, recurStartH, recurStartM);
                const endTimeStr = to24Hour(recurEndAmPm, recurEndH, recurEndM);
                const newItems = recurDays.map(day => ({
                    id: Date.now() + Math.random(), dayOfWeek: day, time: timeStr, endTime: endTimeStr, text: recurText
                }));

                if (editingRecurGroupId) {
                    const oldRepItem = recurring.find(r => r.id === editingRecurGroupId);
                    if (oldRepItem) {
                        const oldIds = recurring.filter(r => r.time === oldRepItem.time && r.endTime === oldRepItem.endTime && r.text === oldRepItem.text).map(r => r.id);
                        const filtered = recurring.filter(r => !oldIds.includes(r.id));
                        setRecurring([...filtered, ...newItems]);
                    } else setRecurring([...recurring, ...newItems]);
                } else setRecurring([...recurring, ...newItems]);
                cancelEditRecur();
            };

            const deleteRecurringGroup = (groupItem) => {
                if (confirm(`${groupItem.text} (${getDayString(groupItem.days)}) 일정을 삭제하시겠습니까?`)) {
                    setRecurring(recurring.filter(r => !groupItem.ids.includes(r.id)));
                }
            };

            const openAddModal = () => {
                setEditingItem(null); setSelectedTime("09:00"); setSelectedTaskText(""); setIsAddScheduleOpen(true);
            };
            const openEditModal = (item) => {
                setEditingItem(item); setSelectedTime(item.time); setSelectedTaskText(item.text); setIsAddScheduleOpen(true);
            };

            const saveSchedule = () => {
                if (!selectedTaskText) return;
                const dateKey = formatDateKey(currentDate);
                const currentDaySchedules = schedules[dateKey] || [];
                
                if (editingItem) {
                    if (editingItem.isRecurring && !editingItem.recurringOriginId) {
                        const newConcrete = { id: Date.now(), time: selectedTime, text: selectedTaskText, completed: false, recurringOriginId: editingItem.id };
                        setSchedules({ ...schedules, [dateKey]: [...currentDaySchedules, newConcrete] });
                    } else {
                        const updated = currentDaySchedules.map(s => s.id === editingItem.id ? { ...s, time: selectedTime, text: selectedTaskText } : s);
                        setSchedules({ ...schedules, [dateKey]: updated });
                    }
                } else {
                    const newEntry = { id: Date.now(), time: selectedTime, text: selectedTaskText, completed: false };
                    setSchedules({ ...schedules, [dateKey]: [...currentDaySchedules, newEntry] });
                }
                setIsAddScheduleOpen(false); setSelectedTaskText(""); setEditingItem(null);
            };

            const toggleComplete = (item, isVirtual, dateKey) => {
                const currentDaySchedules = schedules[dateKey] || [];
                if (isVirtual) {
                    const newConcrete = { ...item, id: Date.now(), recurringOriginId: item.id, completed: true };
                    setSchedules({ ...schedules, [dateKey]: [...currentDaySchedules, newConcrete] });
                } else {
                    const updated = currentDaySchedules.map(s => s.id === item.id ? { ...s, completed: !s.completed } : s);
                    setSchedules({ ...schedules, [dateKey]: updated });
                }
            };

            const deleteSchedule = (id, isVirtual, dateKey) => {
                if (isVirtual) {
                    if(confirm('이 반복 일정을 오늘만 삭제하시겠습니까? (영구 삭제는 설정 메뉴에서 가능)')) {
                        alert("반복 일정 영구 삭제는 우측 상단 메뉴(≡)에서 가능합니다.");
                    }
                } else {
                    if(confirm('이 일정을 삭제하시겠습니까?')) {
                        const currentDaySchedules = schedules[dateKey] || [];
                        setSchedules({ ...schedules, [dateKey]: currentDaySchedules.filter(s => s.id !== id) });
                    }
                }
            };

            // --- Render Logic ---
            const weekDays = getWeekDays(currentDate);
            const dateKey = formatDateKey(currentDate);
            const dayOfWeek = getDayOfWeek(currentDate);

            const todaysRecurring = recurring.filter(r => r.dayOfWeek === dayOfWeek);
            const todaysConcrete = schedules[dateKey] || [];
            const displayItems = [];

            todaysRecurring.forEach(r => {
                const override = todaysConcrete.find(c => c.recurringOriginId === r.id);
                if (!override) displayItems.push({ ...r, isRecurring: true });
            });
            todaysConcrete.forEach(c => displayItems.push({ ...c, isRecurring: !!c.recurringOriginId }));
            displayItems.sort((a, b) => a.time.localeCompare(b.time));

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col font-sans text-gray-800">
                
                {/* Header */}
                <header className={`bg-white px-4 py-4 shadow-sm flex items-center sticky top-0 z-10 ${viewMode === 'monthly' ? 'justify-end' : 'justify-between'}`}>
                    <div className="flex items-center gap-2">
                        {viewMode === 'monthly' ? (
                            <>
                                <button 
                                    key="monthly-home-btn"
                                    onClick={() => setViewMode('weekly')}
                                    className="p-2 bg-blue-500 text-white hover:bg-blue-600 rounded-full shadow-md transition"
                                >
                                    <Home className="w-5 h-5" />
                                </button>
                                {/* Title Removed from Monthly View as requested */}
                            </>
                        ) : (
                            <>
                                <button 
                                    key="weekly-menu-btn"
                                    onClick={() => setIsMenuOpen(true)}
                                    className="p-2 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition"
                                >
                                    <Menu className="w-5 h-5" />
                                </button>
                                <h1 className="text-xl font-bold text-blue-600 flex items-center gap-1">
                                    오늘의 계획
                                </h1>
                            </>
                        )}
                    </div>
                    
                    {/* View Mode Toggle Button */}
                    {viewMode === 'weekly' && (
                        <button 
                            key="calendar-btn"
                            onClick={() => {
                                setViewMode('monthly');
                                setCalendarViewDate(currentDate); 
                            }}
                            className="p-2 bg-blue-500 text-white hover:bg-blue-600 rounded-full shadow-md transition"
                            title="달력 보기"
                        >
                            <CalendarIcon className="w-5 h-5" />
                        </button>
                    )}
                </header>

                {/* Main Content */}
                <main className="flex-1 max-w-lg w-full mx-auto p-4 flex flex-col gap-4">
                    
                    {/* View Switch: Weekly vs Monthly */}
                    {viewMode === 'weekly' ? (
                        /* --- Weekly View --- */
                        <div className="bg-white rounded-2xl shadow-sm p-4">
                            <div className="grid grid-cols-7 gap-1">
                                {weekDays.map((date, idx) => {
                                    const isSelected = formatDateKey(date) === dateKey;
                                    const isToday = formatDateKey(date) === formatDateKey(new Date());
                                    const dNum = date.getDate();
                                    const dIdx = date.getDay();
                                    const dName = getDayName(dIdx);
                                    const colorClass = getDayColor(dIdx);
                                    
                                    return (
                                        <button
                                            key={idx}
                                            onClick={() => setCurrentDate(date)}
                                            className={`relative flex flex-col items-center justify-center w-full h-16 rounded-xl transition-all ${
                                                isSelected 
                                                    ? 'bg-blue-600 shadow-md z-10' 
                                                    : 'bg-gray-50 hover:bg-gray-100'
                                            } ${isToday && !isSelected ? 'border-2 border-blue-200' : ''}`}
                                        >
                                            {isToday && (
                                                <span className={`absolute -top-3 left-1/2 transform -translate-x-1/2 text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm whitespace-nowrap ${isSelected ? 'bg-white text-blue-600' : 'bg-blue-500 text-white'}`}>
                                                    오늘
                                                </span>
                                            )}
                                            <span className={`text-xs font-medium mt-1 ${isSelected ? 'text-blue-200' : colorClass}`}>{dName}</span>
                                            <span className={`text-xl font-bold ${isSelected ? 'text-white' : colorClass}`}>{dNum}</span>
                                        </button>
                                    )
                                })}
                            </div>
                        </div>
                    ) : (
                        /* --- Monthly View --- */
                        <div className="bg-white rounded-2xl shadow-sm p-4 animate-fade-in">
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-gray-100 rounded-full"><ChevronLeft className="w-5 h-5" /></button>
                                <span className="font-bold text-lg">{calendarViewDate.getFullYear()}년 {calendarViewDate.getMonth() + 1}월</span>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-gray-100 rounded-full"><ChevronRight className="w-5 h-5" /></button>
                            </div>
                            
                            <div className="grid grid-cols-7 gap-1 text-center mb-2">
                                {['일','월','화','수','목','금','토'].map((d, i) => (
                                    <div key={i} className={`text-base font-bold ${i===0?'text-red-500':i===6?'text-blue-500':'text-gray-500'}`}>{d}</div>
                                ))}
                            </div>
                            
                            <div className="grid grid-cols-7 gap-1">
                                {getMonthDays(calendarViewDate).map((date, i) => {
                                    if (!date) return <div key={i}></div>;
                                    const isToday = formatDateKey(date) === formatDateKey(new Date());
                                    const isSelected = formatDateKey(date) === formatDateKey(currentDate);
                                    const dayIdx = date.getDay();
                                    
                                    return (
                                        <button
                                            key={i}
                                            onClick={() => setCurrentDate(date)}
                                            className={`h-12 rounded-lg flex flex-col items-center justify-center transition relative
                                                ${isSelected ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-gray-100'}
                                                ${isToday && !isSelected ? 'border border-blue-500 text-blue-600' : ''}
                                                ${!isSelected && !isToday ? (dayIdx===0?'text-red-500':dayIdx===6?'text-blue-500':'text-gray-700') : ''}
                                            `}
                                        >
                                            {isToday && !isSelected && <span className="absolute -top-1 right-0 w-2 h-2 bg-blue-500 rounded-full"></span>}
                                            <span className="text-xl font-bold">{date.getDate()}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Schedule List (Visible in both modes) */}
                    <div className="bg-white rounded-2xl shadow-sm min-h-[400px] flex flex-col relative">
                        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-2xl">
                            <h2 className="text-lg font-bold flex items-center gap-2"> {/* Reverted to text-lg */}
                                <span className="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-sm">
                                    {currentDate.getMonth()+1}월 {currentDate.getDate()}일
                                </span>
                                계획표
                            </h2>
                            
                            {/* Conditionally render Add Button only in Weekly mode */}
                            {viewMode === 'weekly' && (
                                <button 
                                    onClick={openAddModal}
                                    className="text-sm bg-black text-white px-3 py-1.5 rounded-full flex items-center gap-1 hover:bg-gray-800 transition shadow-md"
                                >
                                    <Plus className="w-4 h-4" />
                                    일정 추가
                                </button>
                            )}
                        </div>

                        <div className="p-4 flex-1 flex flex-col gap-1 pb-8">
                            {displayItems.length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-full text-gray-400 py-10">
                                    <CalendarIcon className="w-12 h-12 mb-2 opacity-20" />
                                    <p>등록된 일정이 없습니다.</p>
                                    {viewMode === 'weekly' && <p className="text-xs mt-1">상단의 '일정 추가'를 눌러보세요!</p>}
                                </div>
                            ) : (
                                displayItems.map((item, idx) => (
                                    <div 
                                        key={`${item.id}-${idx}`}
                                        className={`group flex items-center gap-3 py-2 px-3 transition-all rounded-lg ${
                                            item.completed 
                                                ? 'bg-white opacity-50' 
                                                : item.isRecurring && !item.recurringOriginId 
                                                    ? 'bg-purple-50' 
                                                    : 'bg-white'
                                        } border-b border-gray-50 last:border-0`}
                                    >
                                        {/* Time */}
                                        <div className={`text-sm font-bold tracking-tighter whitespace-nowrap w-24 flex-shrink-0 text-left ${item.completed ? 'text-gray-300' : 'text-blue-500'}`}>
                                            {getDisplayTime(item)}
                                        </div>

                                        <div className="w-px h-8 bg-gray-100 mx-1"></div>

                                        <div className="flex-1 min-w-0">
                                            <p className={`text-base font-medium whitespace-normal break-words ${item.completed ? 'line-through text-gray-300' : 'text-gray-800'}`}>
                                                {item.text}
                                            </p>
                                            {item.isRecurring && !item.recurringOriginId && (
                                                <span className="text-[10px] font-bold text-purple-600 flex items-center gap-1 mt-0.5 whitespace-nowrap">
                                                    <Repeat className="w-3 h-3" /> 매주 고정
                                                </span>
                                            )}
                                        </div>

                                        {/* Conditionally render actions (only in weekly view) */}
                                        {viewMode === 'weekly' && (
                                            <div className="flex items-center gap-1">
                                                <button onClick={() => openEditModal(item)} className="opacity-0 group-hover:opacity-100 p-1.5 text-gray-300 hover:text-blue-600 rounded-md transition"><Edit2 className="w-4 h-4" /></button>
                                                <button onClick={() => deleteSchedule(item.id, item.isRecurring && !item.recurringOriginId, dateKey)} className="opacity-0 group-hover:opacity-100 p-1.5 text-gray-300 hover:text-red-500 rounded-md transition"><Trash2 className="w-4 h-4" /></button>
                                                <button onClick={() => toggleComplete(item, item.isRecurring && !item.recurringOriginId, dateKey)} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ml-1 flex-shrink-0 ${item.completed ? 'bg-green-400 border-green-400' : 'border-gray-200 hover:border-green-300'}`}>{item.completed && <CheckSquare className="w-3 h-3 text-white" />}</button>
                                            </div>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                        <div className="h-4 bg-white rounded-b-2xl"></div>
                    </div>
                </main>

                {/* --- Unified Menu Modal (Recurring & Tasks) --- */}
                {isMenuOpen && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white w-full max-w-md rounded-2xl shadow-xl flex flex-col max-h-[85vh]">
                            <div className="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl flex-shrink-0">
                                <h3 className="font-bold text-lg text-gray-800">설정 및 관리</h3>
                                <button onClick={() => { setIsMenuOpen(false); cancelEditRecur(); }}><X className="w-5 h-5 text-gray-500" /></button>
                            </div>
                            
                            <div className="overflow-y-auto p-4 space-y-8 flex-1 min-h-0">
                                
                                {/* Section 1: Recurring Schedules */}
                                <section>
                                    <h4 className="flex items-center gap-2 font-bold text-blue-700 mb-3 text-base">
                                        <CheckSquare className="w-4 h-4" />
                                        {editingRecurGroupId ? '고정 스케줄 수정' : '고정 스케줄 추가'}
                                    </h4>
                                    
                                    <div className={`p-4 rounded-xl mb-4 border transition-colors ${editingRecurGroupId ? 'bg-orange-50 border-orange-200' : 'bg-blue-50 border-blue-100'}`}>
                                        <div className="flex flex-col gap-3">
                                            {/* Manual Time Inputs with AM/PM Selector */}
                                            <div className="flex items-center gap-1 flex-wrap">
                                                {/* Start Time */}
                                                <div className="flex items-center gap-1 bg-white p-1 rounded border">
                                                    <button 
                                                        onClick={() => toggleAmPm(setRecurStartAmPm, recurStartAmPm)}
                                                        className="px-1.5 py-0.5 text-xs font-bold bg-gray-100 rounded hover:bg-gray-200 text-blue-600 min-w-[32px]"
                                                    >
                                                        {recurStartAmPm}
                                                    </button>
                                                    <input 
                                                        type="text" inputMode="numeric" maxLength={2}
                                                        className="w-8 text-center p-1 outline-none text-sm font-bold appearance-none"
                                                        value={recurStartH}
                                                        onChange={(e) => setRecurStartH(e.target.value)}
                                                        placeholder="시"
                                                    />
                                                    <span className="text-gray-400">:</span>
                                                    <input 
                                                        type="text" inputMode="numeric" maxLength={2}
                                                        className="w-8 text-center p-1 outline-none text-sm font-bold appearance-none"
                                                        value={recurStartM}
                                                        onChange={(e) => setRecurStartM(e.target.value)}
                                                        placeholder="분"
                                                    />
                                                </div>
                                                <span className="text-gray-400 text-sm">~</span>
                                                {/* End Time */}
                                                <div className="flex items-center gap-1 bg-white p-1 rounded border">
                                                    <button 
                                                        onClick={() => toggleAmPm(setRecurEndAmPm, recurEndAmPm)}
                                                        className="px-1.5 py-0.5 text-xs font-bold bg-gray-100 rounded hover:bg-gray-200 text-blue-600 min-w-[32px]"
                                                    >
                                                        {recurEndAmPm}
                                                    </button>
                                                    <input 
                                                        type="text" inputMode="numeric" maxLength={2}
                                                        className="w-8 text-center p-1 outline-none text-sm font-bold appearance-none"
                                                        value={recurEndH}
                                                        onChange={(e) => setRecurEndH(e.target.value)}
                                                        placeholder="시"
                                                    />
                                                    <span className="text-gray-400">:</span>
                                                    <input 
                                                        type="text" inputMode="numeric" maxLength={2}
                                                        className="w-8 text-center p-1 outline-none text-sm font-bold appearance-none"
                                                        value={recurEndM}
                                                        onChange={(e) => setRecurEndM(e.target.value)}
                                                        placeholder="분"
                                                    />
                                                </div>
                                            </div>

                                            <input 
                                                type="text"
                                                placeholder="내용 (예: 수학학원)"
                                                className="w-full p-2 rounded-lg border text-sm"
                                                value={recurText}
                                                onChange={(e) => setRecurText(e.target.value)}
                                            />
                                            
                                            {/* Day Selector */}
                                            <div className="flex justify-between gap-1">
                                                {['일','월','화','수','목','금','토'].map((d, i) => (
                                                    <button
                                                        key={i}
                                                        onClick={() => toggleRecurDay(i)}
                                                        className={`w-9 h-9 rounded-full text-xs font-bold transition-all ${
                                                            recurDays.includes(i)
                                                                ? 'bg-blue-600 text-white shadow-md'
                                                                : 'bg-white border text-gray-400 hover:border-blue-300'
                                                        } ${i===0 ? 'text-red-300' : i===6 ? 'text-blue-300' : ''}`}
                                                    >
                                                        {d}
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            <div className="flex gap-2">
                                                {editingRecurGroupId && (
                                                    <button 
                                                        onClick={cancelEditRecur}
                                                        className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg text-sm font-bold hover:bg-gray-300"
                                                    >
                                                        취소
                                                    </button>
                                                )}
                                                <button 
                                                    onClick={saveRecurringSchedule}
                                                    className={`flex-1 py-2 rounded-lg text-sm font-bold text-white transition disabled:opacity-50 ${editingRecurGroupId ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-600 hover:bg-blue-700'}`}
                                                    disabled={!recurText || recurDays.length === 0}
                                                >
                                                    {editingRecurGroupId ? '수정 완료' : '고정 스케줄 추가'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    {/* List of Recurring Rules (Grouped) */}
                                    <div className="space-y-2">
                                        {recurring.length > 0 && (
                                            // Use grouped items
                                            getGroupedRecurring().map((groupItem, idx) => (
                                                <div key={idx} className={`flex justify-between items-center border p-2 rounded-lg text-sm shadow-sm ${editingRecurGroupId === groupItem.id ? 'bg-orange-50 border-orange-200 ring-1 ring-orange-300' : 'bg-white'}`}>
                                                    <div className="flex flex-col gap-0.5">
                                                        <div className="flex items-center gap-2">
                                                            {/* Display grouped days */}
                                                            <span className="text-xs font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded">
                                                                {getDayString(groupItem.days)}
                                                            </span>
                                                            <span className="font-bold text-gray-600 text-xs whitespace-nowrap">{getDisplayTime(groupItem)}</span>
                                                        </div>
                                                        <span className="truncate max-w-[200px] text-gray-800 ml-1">{groupItem.text}</span>
                                                    </div>
                                                    <div className="flex items-center gap-1">
                                                        <button onClick={() => startEditRecurGroup(groupItem)} className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded">
                                                            <Edit2 className="w-4 h-4" />
                                                        </button>
                                                        <button onClick={() => deleteRecurringGroup(groupItem)} className="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded">
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </section>

                                <div className="border-t"></div>

                                {/* Section 2: Task Pool */}
                                <section>
                                    <h4 className="flex items-center gap-2 font-bold text-gray-700 mb-3 text-base">
                                        <CheckSquare className="w-4 h-4" />
                                        할 일 저장소
                                    </h4>
                                    <div className="flex gap-2 mb-3">
                                        <input 
                                            type="text"
                                            placeholder="자주 쓰는 할 일"
                                            className="flex-1 p-2 border rounded-lg text-sm"
                                            id="newTaskInput"
                                            onKeyDown={(e) => {
                                                if(e.key==='Enter') {
                                                    addTaskToPool(e.target.value);
                                                    e.target.value = '';
                                                }
                                            }}
                                        />
                                        <button 
                                            onClick={() => {
                                                const input = document.getElementById('newTaskInput');
                                                addTaskToPool(input.value);
                                                input.value = '';
                                            }}
                                            className="bg-black text-white px-3 py-2 rounded-lg text-sm"
                                        >
                                            저장
                                        </button>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {tasks.map((task, idx) => (
                                            <span key={idx} className="flex items-center gap-1 bg-gray-100 px-3 py-1 rounded-full text-sm text-gray-700">
                                                {task}
                                                <button onClick={() => removeTaskFromPool(task)} className="text-gray-400 hover:text-red-500 ml-1">
                                                    <X className="w-3 h-3" />
                                                </button>
                                            </span>
                                        ))}
                                        
                                    </div>
                                </section>

                            </div>
                        </div>
                    </div>
                )}

                {/* --- Add Schedule Modal (Simplified) --- */}
                {isAddScheduleOpen && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center sm:p-4">
                        <div className="bg-white w-full max-w-sm rounded-t-2xl sm:rounded-2xl shadow-xl flex flex-col animate-slide-up sm:animate-none">
                            <div className="p-4 border-b flex justify-between items-center">
                                <h3 className="font-bold text-lg">{editingItem ? '일정 수정' : '일정 추가'}</h3>
                                <button onClick={() => setIsAddScheduleOpen(false)}><X className="w-5 h-5 text-gray-400" /></button>
                            </div>
                            
                            <div className="p-5 flex flex-col gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block">시간 선택</label>
                                    <select 
                                        className="w-full p-3 border rounded-xl bg-white text-base font-medium focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        value={selectedTime}
                                        onChange={(e) => setSelectedTime(e.target.value)}
                                    >
                                        {generateTimeSlots().map(slot => (
                                            <option key={slot.value} value={slot.value}>{slot.label}</option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block">할 일 선택</label>
                                    {tasks.length > 0 && (
                                        <div className="flex flex-wrap gap-2 mb-2">
                                            {tasks.map((task, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => setSelectedTaskText(task)}
                                                    className={`px-3 py-1.5 rounded-full text-sm border transition ${
                                                        selectedTaskText === task 
                                                            ? 'bg-blue-600 text-white border-blue-600' 
                                                            : 'bg-white text-gray-600 border-gray-200 hover:border-blue-300'
                                                    }`}
                                                >
                                                    {task}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                    <input 
                                        type="text" 
                                        placeholder="할 일을 입력하세요..." 
                                        className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        value={selectedTaskText}
                                        onChange={(e) => setSelectedTaskText(e.target.value)}
                                    />
                                </div>

                                <button 
                                    onClick={saveSchedule}
                                    disabled={!selectedTaskText}
                                    className="w-full py-3.5 bg-black text-white rounded-xl font-bold text-lg hover:bg-gray-800 disabled:opacity-50 mt-2 shadow-lg"
                                >
                                    {editingItem ? '수정 완료' : '일정 등록'}
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                <style>{`
                    .scrollbar-hide::-webkit-scrollbar { display: none; }
                    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
                    @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
                    .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
                    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
                    .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
                `}</style>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<TodaysPlan />);
    </script>
</body>
</html>
